---
# Tasks for tesing role

- name: test docker_provisioner role
  hosts: localhost

  tasks:

    - block:

      - name: cleanup log file
        copy:
          content: ""
          dest: ./test.log
          force: no

      # Test image provisioning

      - include_role:
          name: docker_provisioner
        vars:
          docker_provisioner_images: "{{ docker_provisioner_default_images }}"
          docker_provisioner_image_state: present
          docker_provisioner_image_force: true

      # Test container provisioning

      - block:
        - include_role:
            name: docker_provisioner
          vars:
            docker_provisioner_container_tty: true

        - name: save fact with provisioned containers for later cleanup
          set_fact:
            tty_containers: "{{ docker_provisioner_default_containers }}"

        - name: test ssh containers provisioning
          include_role:
            name: docker_provisioner
          vars:
            docker_provisioner_container_tty: false

        - name: save fact with provisioned containers for later cleanup
          set_fact:
             ssh_containers: "{{ docker_provisioner_default_containers }}"

        vars:
          docker_provisioner_containers: >
            {{ docker_provisioner_default_containers }}
          docker_provisioner_container_state: started
          docker_provisioner_container_restart: true

      always:

        # Cleanup testing containers

        - include_role:
            name: docker_provisioner
          vars:
            docker_provisioner_containers: >
              {{ tty_containers + ssh_containers }}
            docker_provisioner_container_state: absent
