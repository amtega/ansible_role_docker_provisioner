---
# Tasks for testing role

- name: configure vagrant sandbox environment
  hosts: localhost
  roles:
    - role: amtega.vagrant_presets
  tasks:
    - set_fact:
        vagrant_sandbox_boxes: >-
          {{ (vagrant_presets_boxes + extra_boxes)
             | rejectattr("name", "search", "centos_6")
             | list }}
        vagrant_sandbox_vms: >-
          {{ (vagrant_presets_vms + extra_vms)
             | rejectattr("name", "search", "centos_6")
             | list
             | vagrant_presets_randomize_names }}
  vars:
    extra_boxes:
      - name: debian_9
        address: generic/debian9
    extra_vms:
      - name: debian_9
        box: debian_9
        hostname: debian-9
        ansible_become: true
  tags:
    - sandbox

- name: run idempotence test
  hosts: localhost
  roles:
    - role: amtega.vagrant_sandbox
      vagrant_sandbox_state: started
  tags:
    - sandbox

- name: configure docker_provisioner role
  hosts: vagrant_sandbox_vms
  serial: 1
  roles:
    - role: amtega.docker_engine
    - role: amtega.docker_presets
  tasks:
    - name: setup docker_provisioner common variables
      set_fact:
        docker_provisioner_images: "{{ docker_presets_images }}"
        docker_provisioner_image_state: present

    - name: setup docker_provisioner tty containers presets
      set_fact:
        docker_provisioner_containers_tty: >-
          {{ docker_presets_containers | docker_presets_randomize_names }}

    - name: setup docker_provisioner no tty containers presets
      set_fact:
        docker_provisioner_containers_no_tty: >-
          {{ docker_presets_containers | docker_presets_randomize_names }}
  tags:
    - idempotence

- name: test docker_provisioner role provisioning
  hosts: vagrant_sandbox_vms
  roles:
    - role: amtega.docker_provisioner
      docker_provisioner_containers: "{{ docker_provisioner_containers_tty }}"
      docker_provisioner_container_tty: true
      docker_provisioner_container_state: started

    - role: amtega.docker_provisioner
      docker_provisioner_images: []
      docker_provisioner_containers: >-
        {{ docker_provisioner_containers_no_tty }}
      docker_provisioner_container_tty: false
      docker_provisioner_container_state: started
  tags:
    - idempotence

- name: test docker_provisioner role cleanup
  hosts: vagrant_sandbox_vms
  roles:
    - role: amtega.docker_provisioner
      docker_provisioner_containers: "{{ docker_provisioner_containers_tty }}"
      docker_provisioner_container_state: absent

    - role: amtega.docker_provisioner
      docker_provisioner_containers: >-
        {{ docker_provisioner_containers_no_tty }}
      docker_provisioner_container_state: absent

- name: cleanup vagrant sandbox
  hosts: localhost
  roles:
    - role: amtega.vagrant_sandbox
      vagrant_sandbox_state: absent
  tags:
    - sandbox
