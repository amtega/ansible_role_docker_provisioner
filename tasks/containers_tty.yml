---
# Setup connection of docker containers that use tty

- block:
    - name: setup containers tty
      add_host:
        name: "{{ container.1.name }}"
        ansible_host: "{{ container.1.name }}"
        docker_ip: >-
          {{ docker_provisioner_get_ip_result.results[container.0].stdout }}
        ansible_connection: docker
      when:
        - >
          container.tty
          | default(docker_provisioner_container_tty)
        - >
          container.state
          | default(docker_provisioner_container_state) == "started"
      changed_when: false
      with_indexed_items: "{{ docker_provisioner_containers }}"
      loop_control:
        label: "{{ container.1.name }}"
        loop_var: container

    - name: ensure that is possible to connect with tty to docker containers
      shell:
        docker exec -t {{ item.name }}
        echo '{{ test_message }}'
      when:
        - >
          item.tty
          | default(docker_provisioner_container_tty)
        - >
          item.state
          | default(docker_provisioner_container_state) == "started"
      changed_when: false
      register: docker_provisioner_tty_connection_result
      failed_when: >-
          not docker_provisioner_tty_connection_result.stdout
              is search(test_message)
      loop: "{{ docker_provisioner_containers }}"
      vars:
        test_message: "Docker container is up"
      loop_control:
        label: "{{ item.name }}"
  vars:
    default_options: "{{ docker_provisioner_container_options }}"
    default_containers: "{{ docker_provisioner_container_options }}"
  tags:
    - role::docker_provisioner
    - role::docker_provisioner::containers
